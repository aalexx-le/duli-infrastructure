---
# ============================================================================
# KUBESPRAY RUNTIME CONFIGURATION
# ============================================================================
# Runtime settings consumed by kubespray playbook for cluster deployment.
# These control download behavior, container runtime, and deployment options.

# Download Configuration
local_release_dir: /tmp/releases
download_cache_dir: /tmp/kubespray_cache
download_run_once: true
download_localhost: false
download_container: false

# Container Runtime
container_manager: "containerd"
deploy_netchecker: false

# etcd Deployment
etcd_deployment_type: "kubeadm"

# ArgoCD Deployment (managed by kubespray)
# Reference: infrastructure-kubernetes/kubespray/roles/kubernetes-apps/argocd/
argocd_enabled: true
argocd_namespace: "argocd"
argocd_version: "2.14.5"
argocd_admin_password: "{{ vault_argocd_admin_password }}"

# ============================================================================
# INGRESS-NGINX CONFIGURATION
# ============================================================================
# Ingress controller for routing external traffic to services via Cloudflare.
# Architecture: Internet → Cloudflare → LoadBalancer → ingress-nginx → Services

ingress_nginx_enabled: true
ingress_nginx_namespace: "ingress-nginx"
ingress_nginx_service_type: LoadBalancer
ingress_nginx_class: nginx
ingress_nginx_default: true

# NGINX ConfigMap settings for Cloudflare integration
# Reference: https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/
ingress_nginx_configmap:
  # Cloudflare Real IP - preserve client IPs through proxy
  compute-full-forwarded-for: "true"
  use-forwarded-headers: "true"
  use-proxy-protocol: "false"
  # Cloudflare IP ranges for trusted proxies
  proxy-real-ip-cidr: "173.245.48.0/20,103.21.244.0/22,103.22.200.0/22,103.31.4.0/22,141.101.64.0/18,108.162.192.0/18,190.93.240.0/20,188.114.96.0/20,197.234.240.0/22,198.41.128.0/17,162.158.0.0/15,172.64.0.0/13,131.0.72.0/22,2400:cb00::/32,2606:4700::/32,2803:f800::/32,2405:b500::/32,2405:8100::/32,2a06:98c0::/29,2c0f:f248::/32"
  # SSL/TLS Configuration for Full (Strict) mode
  ssl-protocols: "TLSv1.2 TLSv1.3"
  ssl-ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305"
  ssl-redirect: "true"
  force-ssl-redirect: "true"
  # HSTS for Cloudflare Full (Strict) compatibility
  hsts: "true"
  hsts-include-subdomains: "true"
  hsts-max-age: "31536000"
  hsts-preload: "false"
  # Performance settings
  client-max-body-size: "100m"
  proxy-body-size: "100m"
  proxy-read-timeout: "600"
  proxy-send-timeout: "600"

# ============================================================================
# TCP SERVICE CONFIGURATION (for external access via LoadBalancer)
# ============================================================================
# Maps external LoadBalancer ports to internal Kubernetes services.
# NOTE: These are for EXTERNAL access only (developers, tools, CI/CD).
# Applications inside the cluster continue using ClusterIP service names.
#
# Usage:
# - External PostgreSQL: psql -h db-staging.duli.one -p 5432
# - Internal PostgreSQL: database-rw.staging.svc.cluster.local:5432
ingress_nginx_configmap_tcp_services:
  "5432": "staging/database-rw:5432"
  "6379": "staging/redis-replication-master:6379"
  "5672": "staging/queue:5672"
  # Production namespaces
  "5433": "prod/database-rw:5432"
  "6380": "prod/redis-replication-master:6379"
  "5673": "prod/queue:5672"

# Security Configuration (commented - enable for production)
# kube_encrypt_secret_data: true
# kube_encryption_algorithm: "aescbc"
# kube_encryption_resources:
#   - secrets
