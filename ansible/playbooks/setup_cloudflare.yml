---
# ============================================================================
# CLOUDFLARE SETUP PLAYBOOK
# ============================================================================
# Deploys cloudflared tunnel for a specific environment.
#
# Usage:
#   # Deploy staging
#   ansible-playbook -i inventories/hosts.ini playbooks/setup_cloudflare.yml -e target_environment=staging
#
#   # Deploy production
#   ansible-playbook -i inventories/hosts.ini playbooks/setup_cloudflare.yml -e target_environment=prod
# ============================================================================

- name: Complete Cloudflare Setup (Tunnel + DNS + SSL)
  hosts: localhost
  connection: local
  gather_facts: true
  vars:
    cloudflare_zone: "duli.one"
    cloudflare_email: "engineer.duli@gmail.com"
    tunnel_name: "duli-tunnel"
    helm_chart_path: "{{ playbook_dir }}/../../helm/cloudflared"
    
    # Environment-specific configurations
    env_configs:
      staging:
        namespace: "staging"
        values_file: "values-staging.yaml"
        subdomains:
          - name: "api.staging"
            type: "CNAME"
            content: "duli.one"
          - name: "ai.staging"
            type: "CNAME"
            content: "duli.one"
          - name: "n8n.staging"
            type: "CNAME"
            content: "duli.one"
          - name: "auth.staging"
            type: "CNAME"
            content: "duli.one"
          - name: "queue.staging"
            type: "CNAME"
            content: "duli.one"
        tunnel_dns_records:
          - "db.staging"
          - "redis.staging"
          - "mq.staging"
      prod:
        namespace: "prod"
        values_file: "values-prod.yaml"
        subdomains:
          - name: "@"
            type: "A"
          - name: "api"
            type: "CNAME"
            content: "duli.one"
          - name: "ai"
            type: "CNAME"
            content: "duli.one"
          - name: "n8n"
            type: "CNAME"
            content: "duli.one"
          - name: "auth"
            type: "CNAME"
            content: "duli.one"
          - name: "argocd"
            type: "CNAME"
            content: "duli.one"
          - name: "rancher"
            type: "CNAME"
            content: "duli.one"
          - name: "queue"
            type: "CNAME"
            content: "duli.one"
        tunnel_dns_records:
          - "db"
          - "redis"
          - "mq"

  tasks:
    # ========================================================================
    # VALIDATION
    # ========================================================================
    - name: Validate target_environment variable is provided
      assert:
        that:
          - target_environment is defined
          - target_environment | length > 0
          - target_environment in ['staging', 'prod']
        fail_msg: "target_environment variable is required. Use: -e target_environment=staging or -e target_environment=prod"

    - name: Set environment configuration
      set_fact:
        env_config: "{{ env_configs[target_environment] }}"
        cloudflared_namespace: "{{ env_configs[target_environment].namespace }}"

    - name: Validate Cloudflare credentials
      assert:
        that:
          - vault_cloudflare_api_token is defined
          - vault_cloudflare_api_token | length > 0
          - vault_cloudflare_api_token != "change-me-to-your-cloudflare-api-token"
          - vault_cloudflare_account_id is defined
          - vault_cloudflare_account_id | length > 0
          - vault_cloudflare_account_id != "change-me-to-your-cloudflare-account-id"
        fail_msg: "Cloudflare API token and Account ID must be set in vault.yml"
    
    - name: Check if cloudflared CLI is installed
      command: which cloudflared
      register: cloudflared_check
      failed_when: false
      changed_when: false
    
    - name: Display cloudflared installation instructions if missing
      fail:
        msg: |
          Install cloudflared CLI:
          macOS: brew install cloudflare/cloudflare/cloudflared
          Linux: wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb && sudo dpkg -i cloudflared-linux-amd64.deb
      when: cloudflared_check.rc != 0
    
    - name: Check if Cloudflare cert exists
      stat:
        path: "{{ ansible_env.HOME }}/.cloudflared/cert.pem"
      register: cloudflare_cert
    
    - name: Authenticate with Cloudflare if needed
      fail:
        msg: "Run: cloudflared tunnel login"
      when: not cloudflare_cert.stat.exists
    
    - name: List existing tunnels
      command: cloudflared tunnel list --output json
      register: tunnel_list
      changed_when: false
    
    - name: Parse tunnel list
      set_fact:
        existing_tunnels: "{{ tunnel_list.stdout | from_json }}"
        tunnel_exists: "{{ tunnel_list.stdout | from_json | selectattr('name', 'equalto', tunnel_name) | list | length > 0 }}"
    
    - name: Get existing tunnel ID
      set_fact:
        tunnel_id: "{{ (existing_tunnels | selectattr('name', 'equalto', tunnel_name) | first).id }}"
      when: tunnel_exists
    
    - name: Create new Cloudflare Tunnel
      command: "cloudflared tunnel --output json create {{ tunnel_name }}"
      register: tunnel_create
      when: not tunnel_exists
    
    - name: Set tunnel ID from creation
      set_fact:
        tunnel_id: "{{ (tunnel_create.stdout | from_json).id }}"
      when: not tunnel_exists
    
    - name: Find and read tunnel credentials
      block:
        - find:
            paths: "{{ ansible_env.HOME }}/.cloudflared"
            patterns: "{{ tunnel_id }}.json"
          register: tunnel_creds_file
        
        - name: Check if credentials file exists
          fail:
            msg: |
              Tunnel credentials file not found: {{ ansible_env.HOME }}/.cloudflared/{{ tunnel_id }}.json
              
              This usually happens when:
              1. The tunnel was created on a different machine
              2. The credentials file was deleted
              
              Solutions:
              1. Delete the existing tunnel and let Ansible create a new one:
                 cloudflared tunnel delete {{ tunnel_name }}
              
              2. Or manually download the credentials from Cloudflare dashboard
          when: tunnel_creds_file.files | length == 0
        
        - slurp:
            src: "{{ tunnel_creds_file.files[0].path }}"
          register: tunnel_creds_content
          when: tunnel_creds_file.files | length > 0
        
        - set_fact:
            tunnel_credentials: "{{ tunnel_creds_content.content | b64decode | from_json }}"
            tunnel_creds_base64: "{{ tunnel_creds_content.content }}"
          when: tunnel_creds_file.files | length > 0
    
    - name: Create namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ cloudflared_namespace }}"
    
    - name: Create tunnel credentials secret
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: cloudflared-credentials
            namespace: "{{ cloudflared_namespace }}"
          type: Opaque
          data:
            credentials.json: "{{ tunnel_creds_base64 }}"
    
    - name: Deploy cloudflared via Helm
      kubernetes.core.helm:
        name: cloudflared
        chart_ref: "{{ helm_chart_path }}"
        release_namespace: "{{ cloudflared_namespace }}"
        create_namespace: true
        values_files:
          - "{{ helm_chart_path }}/{{ env_config.values_file }}"
        values:
          cloudflare:
            account: "{{ vault_cloudflare_account_id }}"
            tunnelName: "{{ tunnel_name }}"
            tunnelId: "{{ tunnel_id }}"
            secretName: cloudflared-credentials
            enableWarp: true
            edgeIPVersion: "4"
        wait: true
        wait_timeout: 5m
    
    - name: Wait for cloudflared pods
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ cloudflared_namespace }}"
        label_selectors:
          - app.kubernetes.io/name=cloudflare-tunnel
      register: cloudflared_pods
      until: >
        cloudflared_pods.resources | length > 0 and
        cloudflared_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length == cloudflared_pods.resources | length
      retries: 30
      delay: 10
    
    - name: Get ingress-nginx LoadBalancer IP
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: ingress-nginx
        namespace: ingress-nginx
      register: ingress_service
      until: >
        ingress_service.resources | length > 0 and
        ingress_service.resources[0].status.loadBalancer.ingress is defined and
        ingress_service.resources[0].status.loadBalancer.ingress | length > 0
      retries: 30
      delay: 10
    
    - name: Extract LoadBalancer IP
      set_fact:
        loadbalancer_ip: "{{ ingress_service.resources[0].status.loadBalancer.ingress[0].ip }}"
    
    - name: Get Cloudflare Zone ID
      uri:
        url: "https://api.cloudflare.com/client/v4/zones?name={{ cloudflare_zone }}"
        method: GET
        headers:
          Authorization: "Bearer {{ vault_cloudflare_api_token }}"
          Content-Type: "application/json"
        status_code: [200]
      register: zone_lookup
    
    - name: Extract Zone ID
      set_fact:
        zone_id: "{{ zone_lookup.json.result[0].id }}"
    
    - name: Configure root A record
      community.general.cloudflare_dns:
        zone: "{{ cloudflare_zone }}"
        record: "{{ cloudflare_zone }}"
        type: A
        value: "{{ loadbalancer_ip }}"
        proxied: yes
        api_token: "{{ vault_cloudflare_api_token }}"
        state: present
      when: target_environment == 'prod'
    
    - name: Configure CNAME records
      community.general.cloudflare_dns:
        zone: "{{ cloudflare_zone }}"
        record: "{{ item.name }}.{{ cloudflare_zone if item.name != '@' else '' }}"
        type: "{{ item.type }}"
        value: "{{ item.content }}"
        proxied: yes
        api_token: "{{ vault_cloudflare_api_token }}"
        state: present
      loop: "{{ env_config.subdomains | selectattr('type', 'equalto', 'CNAME') | list }}"

    - name: Create Cloudflare Tunnel DNS records
      community.general.cloudflare_dns:
        zone: "{{ cloudflare_zone }}"
        record: "{{ item }}.{{ cloudflare_zone }}"
        type: CNAME
        value: "{{ tunnel_id }}.cfargotunnel.com"
        proxied: no
        api_token: "{{ vault_cloudflare_api_token }}"
        state: present
        timeout: 60
      retries: 3
      delay: 5
      register: dns_result
      until: dns_result is succeeded
      loop: "{{ env_config.tunnel_dns_records }}"
    
    - name: Set SSL mode to Full (Strict)
      uri:
        url: "https://api.cloudflare.com/client/v4/zones/{{ zone_id }}/settings/ssl"
        method: PATCH
        headers:
          Authorization: "Bearer {{ vault_cloudflare_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          value: "strict"
        status_code: [200]
    
    - name: Enable Always Use HTTPS
      uri:
        url: "https://api.cloudflare.com/client/v4/zones/{{ zone_id }}/settings/always_use_https"
        method: PATCH
        headers:
          Authorization: "Bearer {{ vault_cloudflare_api_token }}"
        body_format: json
        body:
          value: "on"
        status_code: [200]
    
    - name: Set Minimum TLS Version to 1.2
      uri:
        url: "https://api.cloudflare.com/client/v4/zones/{{ zone_id }}/settings/min_tls_version"
        method: PATCH
        headers:
          Authorization: "Bearer {{ vault_cloudflare_api_token }}"
        body_format: json
        body:
          value: "1.2"
        status_code: [200]
    
    - name: Enable TLS 1.3
      uri:
        url: "https://api.cloudflare.com/client/v4/zones/{{ zone_id }}/settings/tls_1_3"
        method: PATCH
        headers:
          Authorization: "Bearer {{ vault_cloudflare_api_token }}"
        body_format: json
        body:
          value: "on"
        status_code: [200]
    
    - name: Enable Automatic HTTPS Rewrites
      uri:
        url: "https://api.cloudflare.com/client/v4/zones/{{ zone_id }}/settings/automatic_https_rewrites"
        method: PATCH
        headers:
          Authorization: "Bearer {{ vault_cloudflare_api_token }}"
        body_format: json
        body:
          value: "on"
        status_code: [200]
    
    - name: Display deployment summary
      debug:
        msg: |
          ✓ Environment: {{ target_environment }}
          ✓ Namespace: {{ cloudflared_namespace }}
          ✓ Tunnel: {{ tunnel_name }} ({{ tunnel_id }})
          ✓ Replicas: {{ cloudflared_pods.resources | length }}
          ✓ LoadBalancer: {{ loadbalancer_ip }}
          ✓ SSL: Full (Strict), TLS 1.2+
          
          See docs/cloudflare.md for complete domain structure and access instructions.
