---
- name: Deploy infrastructure services
  hosts: localhost
  connection: local
  vars:
    helm_retries: 3
    helm_retry_delay: 10
    pod_wait_timeout: 10
    pod_wait_retries: 10
    pod_wait_delay: 15
    # Map gitops version variables to shorter names
    cert_manager_chart_version: "{{ gitops_cert_manager_chart_version }}"
    argocd_chart_version: "{{ gitops_argocd_chart_version }}"
    rancher_chart_version: "{{ gitops_rancher_chart_version }}"
  tasks:
    - name: Set paths
      set_fact:
        helm_dir: "{{ playbook_dir }}/../../helm"
      run_once: true

    - name: Install CloudNativePG Operator
      kubernetes.core.helm:
        name: cloudnative-pg
        chart_ref: "{{ helm_dir }}/cloudnative-pg"
        release_namespace: cnpg-system
        create_namespace: true
        values_files:
          - "{{ helm_dir }}/cloudnative-pg/values.yaml"
        values:
          crds:
            create: true
      retries: "{{ helm_retries }}"
      delay: "{{ helm_retry_delay }}"
      until: cnpg_result is succeeded
      register: cnpg_result
      run_once: true

    - name: Install RabbitMQ Cluster Operator
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', helm_dir + '/rabbitmq-operator/cluster-operator.yml') | from_yaml_all | list }}"
      register: rabbitmq_result
      run_once: true

    # Deploy infrastructure services to multiple namespaces
    - name: Validate target_environment variable is provided
      assert:
        that:
          - target_environment is defined
          - target_environment | length > 0
        fail_msg: "target_environment variable is required. Use: -e target_environment=staging or -e target_environment=prod"
      run_once: true

    - name: Set target namespace
      set_fact:
        target_namespace: "{{ target_environment }}"
      run_once: true

    # ============================================================================
    # CREATE TARGET NAMESPACE
    # ============================================================================

    - name: "Create {{ target_namespace }} namespace"
      kubernetes.core.k8s:
        name: "{{ target_namespace }}"
        api_version: v1
        kind: Namespace
        state: present
      run_once: true

    # ============================================================================
    # CREATE APPLICATION SECRETS (REQUIRED BEFORE DEPLOYMENTS)
    # ============================================================================

    - name: Create application secrets
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: "{{ item.name }}"
            namespace: "{{ target_namespace }}"
          type: Opaque
          stringData:
            password: "{{ item.password }}"
      loop:
        - name: postgres-credentials
          password: "{{ vault_postgres_password }}"
        - name: redis-credentials
          password: "{{ vault_redis_password }}"
        - name: rabbitmq-credentials
          password: "{{ vault_rabbitmq_password }}"
      loop_control:
        label: "{{ item.name }}"

    # ============================================================================
    # DEPLOY POSTGRESQL (DATABASE)
    # ============================================================================

    - name: "Deploy PostgreSQL database to {{ target_namespace }} via Helm"
      kubernetes.core.helm:
        name: "database-{{ target_namespace }}"
        chart_ref: "{{ helm_dir }}/postgresql-cnpg"
        release_namespace: "{{ target_namespace }}"
        create_namespace: true
        values_files:
          - "{{ helm_dir }}/postgresql-cnpg/values.yaml"
          - "{{ helm_dir }}/postgresql-cnpg/values-{{ target_namespace }}.yaml"
      retries: "{{ helm_retries }}"
      delay: "{{ helm_retry_delay }}"
      register: postgres_result
      until: postgres_result is succeeded
      run_once: true

    - name: "Wait for PostgreSQL pods to be ready in {{ target_namespace }} namespace"
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ target_namespace }}"
        label_selectors:
          - app.kubernetes.io/name=postgresql-cnpg
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_sleep: 5
        wait_timeout: "{{ pod_wait_timeout }}"
      retries: "{{ pod_wait_retries }}"
      delay: "{{ pod_wait_delay }}"
      run_once: true

    # ============================================================================
    # DEPLOY REDIS (CACHE)
    # ============================================================================

    - name: "Deploy Redis cache to {{ target_namespace }} via Helm"
      kubernetes.core.helm:
        name: "cache-{{ target_namespace }}"
        chart_ref: "{{ helm_dir }}/redis"
        release_namespace: "{{ target_namespace }}"
        create_namespace: true
        values_files:
          - "{{ helm_dir }}/redis/values.yaml"
          - "{{ helm_dir }}/redis/values-{{ target_namespace }}.yaml"
        values:
          auth:
            enabled: true
            sentinel: true
            existingSecret: "redis-credentials"
            existingSecretPasswordKey: "password"
      retries: "{{ helm_retries }}"
      delay: "{{ helm_retry_delay }}"
      register: redis_result
      until: redis_result is succeeded
      run_once: true

    - name: "Wait for Redis pods to be ready in {{ target_namespace }} namespace"
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ target_namespace }}"
        label_selectors:
          - app.kubernetes.io/name=redis
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_sleep: 5
        wait_timeout: "{{ pod_wait_timeout }}"
      retries: "{{ pod_wait_retries }}"
      delay: "{{ pod_wait_delay }}"
      run_once: true

    # ============================================================================
    # DEPLOY RABBITMQ (QUEUE)
    # ============================================================================

    - name: "Deploy RabbitMQ queue to {{ target_namespace }} via Helm"
      kubernetes.core.helm:
        name: "queue-{{ target_namespace }}"
        chart_ref: "{{ helm_dir }}/rabbitmq"
        release_namespace: "{{ target_namespace }}"
        create_namespace: true
        values_files:
          - "{{ helm_dir }}/rabbitmq/values.yaml"
          - "{{ helm_dir }}/rabbitmq/values-{{ target_namespace }}.yaml"
      retries: "{{ helm_retries }}"
      delay: "{{ helm_retry_delay }}"
      register: rabbitmq_result
      until: rabbitmq_result is succeeded
      run_once: true

    - name: "Wait for RabbitMQ pods to be ready in {{ target_namespace }} namespace"
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ target_namespace }}"
        label_selectors:
          - app.kubernetes.io/name=rabbitmq
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_sleep: 5
        wait_timeout: "{{ pod_wait_timeout }}"
      retries: "{{ pod_wait_retries }}"
      delay: "{{ pod_wait_delay }}"
      run_once: true

    - name: "Retrieve RabbitMQ default credentials from {{ target_namespace }} namespace"
      kubernetes.core.k8s_info:
        kind: Secret
        name: "queue-default-user"
        namespace: "{{ target_namespace }}"
      register: rabbitmq_secret
      retries: 5
      delay: 10
      until: rabbitmq_secret.resources | length > 0
      run_once: true

    - name: "Get RabbitMQ service details from {{ target_namespace }} namespace"
      kubernetes.core.k8s_info:
        kind: Service
        name: "queue-{{ target_namespace }}"
        namespace: "{{ target_namespace }}"
      register: rabbitmq_service
      retries: 3
      delay: 10
      run_once: true

    - name: "Get PostgreSQL service details from {{ target_namespace }} namespace"
      kubernetes.core.k8s_info:
        kind: Service
        name: "database-{{ target_namespace }}-rw"
        namespace: "{{ target_namespace }}"
      register: postgres_service
      retries: 3
      delay: 10
      run_once: true

    - name: "Get Redis service details from {{ target_namespace }} namespace"
      kubernetes.core.k8s_info:
        kind: Service
        name: "cache"
        namespace: "{{ target_namespace }}"
      register: redis_service
      retries: 3
      delay: 10
      run_once: true

    - name: "Retrieve PostgreSQL credentials from {{ target_namespace }} namespace"
      kubernetes.core.k8s_info:
        kind: Secret
        name: "database-app"
        namespace: "{{ target_namespace }}"
      register: postgres_secret
      retries: 5
      delay: 10
      until: postgres_secret.resources | length > 0
      run_once: true



    # ============================================================================
    # GITOPS TOOLS INSTALLATION
    # ============================================================================



    - name: Ensure required Helm repositories
      block:
        - name: Check if Helm repositories exist
          command: helm repo list
          register: helm_repos_argo
          changed_when: false

        - name: Add Argo Helm repository
          command: helm repo add argo https://argoproj.github.io/argo-helm
          when: "'argo' not in helm_repos_argo.stdout"
          changed_when: "'argo' not in helm_repos_argo.stdout"

        - name: Add Jetstack Helm repository (cert-manager)
          command: helm repo add jetstack https://charts.jetstack.io
          when: "'jetstack' not in helm_repos_argo.stdout"
          changed_when: "'jetstack' not in helm_repos_argo.stdout"

        - name: Add Rancher Helm repository
          command: helm repo add rancher-stable https://releases.rancher.com/server-charts/stable
          when: "'rancher-stable' not in helm_repos_argo.stdout"
          changed_when: "'rancher-stable' not in helm_repos_argo.stdout"

        - name: Update all Helm repositories
          command: helm repo update
          changed_when: false

    - name: Install Cert-Manager
      kubernetes.core.helm:
        name: cert-manager
        chart_ref: jetstack/cert-manager
        release_namespace: cert-manager
        create_namespace: true
        chart_version: "{{ cert_manager_chart_version }}"
        values:
          installCRDs: true
      retries: "{{ helm_retries }}"
      delay: "{{ helm_retry_delay }}"
      until: cert_manager_result is succeeded
      register: cert_manager_result

    - name: Wait for Cert-Manager pods to be ready
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: cert-manager
        label_selectors:
          - app.kubernetes.io/name=cert-manager
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_sleep: 5
        wait_timeout: "{{ pod_wait_timeout }}"
      retries: "{{ pod_wait_retries }}"
      delay: "{{ pod_wait_delay }}"

    - name: Install ArgoCD
      kubernetes.core.helm:
        name: argocd
        chart_ref: argo/argo-cd
        release_namespace: argocd
        create_namespace: true
        chart_version: "{{ argocd_chart_version }}"
        values:
          server:
            service:
              type: LoadBalancer
      retries: "{{ helm_retries }}"
      delay: "{{ helm_retry_delay }}"
      until: argocd_result is succeeded
      register: argocd_result

    - name: Wait for ArgoCD pods to be ready
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: argocd
        label_selectors:
          - app.kubernetes.io/name=argo-cd
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_sleep: 5
        wait_timeout: "{{ pod_wait_timeout }}"
      retries: "{{ pod_wait_retries }}"
      delay: "{{ pod_wait_delay }}"

    - name: Install Rancher
      kubernetes.core.helm:
        name: rancher
        chart_ref: rancher-stable/rancher
        release_namespace: cattle-system
        create_namespace: true
        chart_version: "{{ rancher_chart_version }}"
        values:
          hostname: "{{ rancher_hostname | default('rancher.local') }}"
          bootstrapPassword: "{{ vault_rancher_bootstrap_password | default('admin') }}"
          replicas: 3
          service:
            type: LoadBalancer
      retries: "{{ helm_retries }}"
      delay: "{{ helm_retry_delay }}"
      until: rancher_result is succeeded
      register: rancher_result

    - name: Wait for Rancher pods to be ready
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: cattle-system
        label_selectors:
          - app=rancher
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_sleep: 5
        wait_timeout: "{{ pod_wait_timeout }}"
      retries: "{{ pod_wait_retries }}"
      delay: "{{ pod_wait_delay }}"

    # ============================================================================
    # ARGOCD APPLICATIONS
    # ============================================================================

    - name: Determine environment
      set_fact:
        current_environment: "{{ target_environment }}"
      run_once: true

    - name: Deploy ArgoCD Applications
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', playbook_dir + '/../../gitops/applications/' + item + '.yml.j2') | from_yaml }}"
      vars:
        target_env: "{{ current_environment }}"
      loop:
        - backend
        - ai-service
        - scheduler
      loop_control:
        label: "{{ item }}-{{ current_environment }}"
      retries: 3
      delay: 5
      until: argocd_apps_result is succeeded
      register: argocd_apps_result

    - name: Wait for ArgoCD Applications to sync
      kubernetes.core.k8s_info:
        kind: Application
        namespace: argocd
        name: "{{ item }}"
        wait: true
        wait_condition:
          type: Synced
          status: "True"
        wait_sleep: 10
        wait_timeout: 300
      loop:
        - backend
        - ai-service
        - scheduler
      loop_control:
        label: "{{ item }}-{{ current_environment }}"
      retries: 2
      delay: 15
