---
- name: Deploy infrastructure services
  hosts: localhost
  connection: local
  vars:
    namespace: duli
    helm_retries: 3
    helm_retry_delay: 10
    pod_wait_timeout: 600
    pod_wait_retries: 10
    pod_wait_delay: 15
  tasks:
    - name: Set paths
      set_fact:
        helm_charts_dir: "{{ playbook_dir }}/../../helm/charts"
        helm_values_dir: "{{ playbook_dir }}/../../helm/values"
      run_once: true

    - name: Create namespace
      kubernetes.core.k8s:
        name: "{{ namespace }}"
        api_version: v1
        kind: Namespace
        state: present

    - name: Ensure Bitnami Helm repository
      block:
        - name: Check if Bitnami Helm repository exists
          command: helm repo list
          register: helm_repos
          changed_when: false

        - name: Add Bitnami Helm repository
          command: helm repo add bitnami https://charts.bitnami.com/bitnami
          when: "'bitnami' not in helm_repos.stdout"
          changed_when: true

        - name: Update Bitnami Helm repository
          command: helm repo update bitnami
          changed_when: false

    - name: "Set service config for {{ item.name }}"
      set_fact:
        service_config: "{{ item.config }}"
      loop: "{{ infrastructure_services }}"
      loop_control:
        label: "{{ item.name }}"
      when: item.config is defined

    - name: "Deploy {{ item.name }} via Helm"
      kubernetes.core.helm:
        name: "{{ item.name }}"
        chart_ref: "{{ item.chart }}"
        release_namespace: "{{ namespace }}"
        create_namespace: true
        values: "{{ lookup('template', helm_values_dir + '/' + item.values_file) | from_yaml }}"
      loop: "{{ infrastructure_services }}"
      loop_control:
        label: "{{ item.name }}"
      retries: "{{ helm_retries }}"
      delay: "{{ helm_retry_delay }}"
      until: result is succeeded
      register: helm_result

    - name: "Wait for {{ item.name }} pods to be ready"
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ namespace }}"
        label_selectors: "{{ item.label_selectors }}"
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_sleep: 5
        wait_timeout: "{{ pod_wait_timeout }}"
      loop: "{{ infrastructure_services }}"
      loop_control:
        label: "{{ item.name }}"
      retries: "{{ pod_wait_retries }}"
      delay: "{{ pod_wait_delay }}"
      when: item.wait_for_pods | default(true)
