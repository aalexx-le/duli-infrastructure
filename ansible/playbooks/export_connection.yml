---
- name: Export infrastructure connection information
  hosts: localhost
  connection: local
  vars:
    supported_environments:
      - staging
      - prod
  tasks:
    - name: Validate target_environment variable
      assert:
        that:
          - target_environment is defined
          - target_environment | length > 0
          - target_environment in supported_environments
        fail_msg: "target_environment variable is required. Use: -e target_environment=staging or -e target_environment=prod"

    - name: Set target namespace
      set_fact:
        target_namespace: "{{ target_environment }}"

    - name: Retrieve RabbitMQ credentials (auto-generated by operator)
      kubernetes.core.k8s_info:
        kind: Secret
        name: queue-default-user
        namespace: "{{ target_namespace }}"
      register: rabbitmq_secret
      retries: 5
      delay: 10
      until: rabbitmq_secret.resources | length > 0

    - name: Set connection info variables
      set_fact:
        postgres_user: "{{ vault_postgres_app_username }}"
        postgres_pass: "{{ vault_postgres_app_password }}"
        postgres_db: "duli_db"
        redis_password: "{{ vault_redis_password }}"
        rabbitmq_user: "{{ rabbitmq_secret.resources[0].data.username | b64decode }}"
        rabbitmq_pass: "{{ rabbitmq_secret.resources[0].data.password | b64decode }}"

    - name: Write connection information
      template:
        src: "{{ playbook_dir }}/../templates/connection-info.ini.j2"
        dest: "{{ playbook_dir }}/../connection-info-{{ target_namespace }}.ini"
        mode: '0600'

    - name: Display success message
      debug:
        msg: "âœ“ Connection info: {{ playbook_dir }}/../connection-info-{{ target_namespace }}.ini"
