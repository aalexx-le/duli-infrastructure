---
- name: Export infrastructure connection information
  hosts: localhost
  connection: local
  vars:
    supported_environments:
      - staging
      - prod
  tasks:
    - name: Validate target_environment variable
      assert:
        that:
          - target_environment is defined
          - target_environment | length > 0
          - target_environment in supported_environments
        fail_msg: "target_environment variable is required. Use: -e target_environment=staging or -e target_environment=prod"

    - name: Set target namespace
      set_fact:
        target_namespace: "{{ target_environment }}"

    - name: Retrieve PostgreSQL app user credentials (auto-generated by CNPG operator)
      kubernetes.core.k8s_info:
        kind: Secret
        name: database-app
        namespace: "{{ target_namespace }}"
      register: postgres_secret
      retries: 5
      delay: 10
      until: postgres_secret.resources | length > 0

    - name: Retrieve RabbitMQ credentials (auto-generated by operator)
      kubernetes.core.k8s_info:
        kind: Secret
        name: queue-default-user
        namespace: "{{ target_namespace }}"
      register: rabbitmq_secret
      retries: 5
      delay: 10
      until: rabbitmq_secret.resources | length > 0

    - name: Retrieve Keycloak admin credentials (auto-generated by operator)
      kubernetes.core.k8s_info:
        kind: Secret
        name: "keycloak-instance-{{ target_namespace }}-initial-admin"
        namespace: keycloak-system
      register: keycloak_admin_secret
      retries: 5
      delay: 10
      until: keycloak_admin_secret.resources | length > 0

    - name: Set connection info variables
      set_fact:
        postgres_user: "{{ postgres_secret.resources[0].data.username | b64decode }}"
        postgres_pass: "{{ postgres_secret.resources[0].data.password | b64decode }}"
        postgres_db: "{{ postgres_secret.resources[0].data.dbname | b64decode }}"
        redis_password: "{{ vault_redis_password }}"
        rabbitmq_user: "{{ rabbitmq_secret.resources[0].data.username | b64decode }}"
        rabbitmq_pass: "{{ rabbitmq_secret.resources[0].data.password | b64decode }}"
        keycloak_admin_user: "{{ keycloak_admin_secret.resources[0].data.username | b64decode }}"
        keycloak_admin_pass: "{{ keycloak_admin_secret.resources[0].data.password | b64decode }}"
        argocd_admin_user: "admin"
        argocd_admin_pass: "{{ vault_argocd_admin_password }}"
        grafana_admin_user: "admin"
        grafana_admin_pass: "{{ vault_grafana_admin_password }}"

    - name: Write connection information
      template:
        src: "{{ playbook_dir }}/../templates/connection-info.ini.j2"
        dest: "{{ playbook_dir }}/../connection-info-{{ target_namespace }}.ini"
        mode: '0600'

    - name: Display success message
      debug:
        msg: "âœ“ Connection info: {{ playbook_dir }}/../connection-info-{{ target_namespace }}.ini"
