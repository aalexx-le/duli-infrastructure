---
- name: Deploy core infrastructure
  hosts: localhost
  connection: local
  vars:
    helm_retries: 3
    helm_retry_delay: 10
    pod_wait_timeout: 10
    pod_wait_retries: 10
    pod_wait_delay: 15
    cert_manager_chart_version: "{{ helm_cert_manager_chart_version }}"
    rancher_chart_version: "{{ helm_rancher_chart_version }}"
  tasks:
    - name: Validate target_environment variable is provided
      assert:
        that:
          - target_environment is defined
          - target_environment | length > 0
        fail_msg: "target_environment variable is required. Use: -e target_environment=staging or -e target_environment=prod"
      run_once: true

    - name: Set target namespace
      set_fact:
        target_namespace: "{{ target_environment }}"
      run_once: true

    - name: "Create {{ target_namespace }} namespace"
      kubernetes.core.k8s:
        name: "{{ target_namespace }}"
        api_version: v1
        kind: Namespace
        state: present
      run_once: true

    - name: Ensure required Helm repositories
      block:
        - name: Check if Helm repositories exist
          command: helm repo list
          register: helm_repos_argo
          changed_when: false

        - name: Add Argo Helm repository
          command: helm repo add argo https://argoproj.github.io/argo-helm
          when: "'argo' not in helm_repos_argo.stdout"
          changed_when: "'argo' not in helm_repos_argo.stdout"

        - name: Add Jetstack Helm repository (cert-manager)
          command: helm repo add jetstack https://charts.jetstack.io
          when: "'jetstack' not in helm_repos_argo.stdout"
          changed_when: "'jetstack' not in helm_repos_argo.stdout"

        - name: Add Rancher Helm repository
          command: helm repo add rancher-stable https://releases.rancher.com/server-charts/stable
          when: "'rancher-stable' not in helm_repos_argo.stdout"
          changed_when: "'rancher-stable' not in helm_repos_argo.stdout"

        - name: Update all Helm repositories
          command: helm repo update
          changed_when: false

    - name: Install Cert-Manager
      kubernetes.core.helm:
        name: cert-manager
        chart_ref: jetstack/cert-manager
        release_namespace: cert-manager
        create_namespace: true
        chart_version: "{{ cert_manager_chart_version }}"
        values:
          installCRDs: true
      retries: "{{ helm_retries }}"
      delay: "{{ helm_retry_delay }}"
      until: cert_manager_result is succeeded
      register: cert_manager_result

    - name: Wait for Cert-Manager pods to be ready
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: cert-manager
        label_selectors:
          - app.kubernetes.io/name=cert-manager
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_sleep: 5
        wait_timeout: "{{ pod_wait_timeout }}"
      retries: "{{ pod_wait_retries }}"
      delay: "{{ pod_wait_delay }}"

    - name: Ensure shared namespaces exist for Cloudflare secret
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ item }}"
      loop:
        - argocd
        - keycloak-system
      run_once: true

    - name: Create Cloudflare API token secret (shared namespaces)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: cloudflare-api-token
            namespace: "{{ item }}"
          type: Opaque
          stringData:
            api-token: "{{ vault_cloudflare_api_token }}"
      loop:
        - cert-manager
        - argocd
        - keycloak-system
      when: vault_cloudflare_api_token is defined
      no_log: true
      run_once: true

    - name: Create Cloudflare API token secret (environment namespace)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: cloudflare-api-token
            namespace: "{{ target_namespace }}"
          type: Opaque
          stringData:
            api-token: "{{ vault_cloudflare_api_token }}"
      when: vault_cloudflare_api_token is defined
      no_log: true

    - name: Install Rancher
      kubernetes.core.helm:
        name: rancher
        chart_ref: rancher-stable/rancher
        release_namespace: cattle-system
        create_namespace: true
        chart_version: "{{ rancher_chart_version }}"
        values:
          hostname: "{{ rancher_hostname | default('rancher.local') }}"
          bootstrapPassword: "{{ vault_rancher_bootstrap_password | default('admin') }}"
          replicas: 3
          # TLS is terminated at ingress-nginx, tell Rancher not to redirect HTTP to HTTPS
          tls: external
          ingress:
            ingressClassName: nginx
          service:
            type: "{{ rancher_service_type | default('LoadBalancer') }}"
      retries: "{{ helm_retries }}"
      delay: "{{ helm_retry_delay }}"
      until: rancher_result is succeeded
      register: rancher_result

    - name: Wait for Rancher pods to be ready
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: cattle-system
        label_selectors:
          - app=rancher
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_sleep: 5
        wait_timeout: "{{ pod_wait_timeout }}"
      retries: "{{ pod_wait_retries }}"
      delay: "{{ pod_wait_delay }}"

    - name: Create Rancher TLS certificate using ClusterIssuer
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: cert-manager.io/v1
          kind: Certificate
          metadata:
            name: tls-rancher-ingress
            namespace: cattle-system
          spec:
            secretName: tls-rancher-ingress
            issuerRef:
              name: letsencrypt-prod
              kind: ClusterIssuer
            dnsNames:
              - "{{ rancher_hostname }}"

    - name: Patch Rancher ingress with TLS configuration
      kubernetes.core.k8s:
        state: patched
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: rancher
            namespace: cattle-system
          spec:
            tls:
              - hosts:
                  - "{{ rancher_hostname }}"
                secretName: tls-rancher-ingress

    - name: Configure ArgoCD server service as ClusterIP
       kubernetes.core.k8s:
         state: patched
         definition:
           apiVersion: v1
           kind: Service
           metadata:
             name: argocd-server
             namespace: argocd
           spec:
             type: ClusterIP
             selector:
               app.kubernetes.io/name: argocd-server
             ports:
               - name: http
                 port: 80
                 targetPort: 8080
                 protocol: TCP
       register: argocd_service_result
       retries: 3
       delay: 10
       until: argocd_service_result is succeeded
       run_once: true

    - name: Determine environment
      set_fact:
        current_environment: "{{ target_environment }}"
      run_once: true

    - name: Deploy shared ArgoCD Applications (run once)
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', playbook_dir + '/../../gitops/applications/' + item + '.yml.j2') | from_yaml }}"
      loop:
        - sealed-secrets-controller
        - cert-manager-issuers
        - cloudnative-pg-operator
        - rabbitmq-operator
        - keycloak-operator
        - redis-operator
        - argocd-ingress
      loop_control:
        label: "{{ item }}"
      retries: 3
      delay: 5
      until: argocd_shared_apps_result is succeeded
      register: argocd_shared_apps_result
      run_once: true

    - name: Wait for shared ArgoCD Applications to sync
      kubernetes.core.k8s_info:
        kind: Application
        namespace: argocd
        name: "{{ item }}"
        wait: true
        wait_condition:
          type: Synced
          status: "True"
        wait_sleep: 10
        wait_timeout: 300
      loop:
        - sealed-secrets-controller
        - cert-manager-issuers
        - cloudnative-pg-operator
        - rabbitmq-operator
        - keycloak-operator
        - redis-operator
        - argocd-ingress
      loop_control:
        label: "{{ item }}"
      retries: 2
      delay: 15
      run_once: true

    # =========================================================================
    # MONITORING STACK DEPLOYMENT
    # =========================================================================
    # Deploys shared monitoring infrastructure to 'monitoring' namespace.
    # Collects metrics and logs from ALL namespaces (staging, prod, etc.)

    - name: Create monitoring namespace
      kubernetes.core.k8s:
        name: monitoring
        api_version: v1
        kind: Namespace
        state: present
      run_once: true

    - name: Create Grafana admin credentials secret
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: grafana-admin-credentials
            namespace: monitoring
          type: Opaque
          stringData:
            admin-user: admin
            admin-password: "{{ vault_grafana_admin_password }}"
      when: vault_grafana_admin_password is defined
      no_log: true
      run_once: true

    - name: Create Cloudflare API token secret for monitoring namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: cloudflare-api-token
            namespace: monitoring
          type: Opaque
          stringData:
            api-token: "{{ vault_cloudflare_api_token }}"
      when: vault_cloudflare_api_token is defined
      no_log: true
      run_once: true

    - name: Deploy Monitoring ArgoCD Applications
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', playbook_dir + '/../../gitops/applications/' + item + '.yml.j2') | from_yaml }}"
      loop:
        - kube-prometheus-stack
        - loki
      loop_control:
        label: "{{ item }}"
      retries: 3
      delay: 5
      until: argocd_monitoring_apps_result is succeeded
      register: argocd_monitoring_apps_result
      when: monitoring_prometheus_stack_enabled | default(true) | bool
      run_once: true

    - name: Wait for Monitoring ArgoCD Applications to sync
      kubernetes.core.k8s_info:
        kind: Application
        namespace: argocd
        name: "{{ item }}"
        wait: true
        wait_condition:
          type: Synced
          status: "True"
        wait_sleep: 10
        wait_timeout: 600
      loop:
        - kube-prometheus-stack
        - loki
      loop_control:
        label: "{{ item }}"
      retries: 3
      delay: 30
      when: monitoring_prometheus_stack_enabled | default(true) | bool
      run_once: true
