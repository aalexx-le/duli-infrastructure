---
- name: Export infrastructure connection information
  hosts: localhost
  connection: local
  tasks:
    - name: Validate target_environment variable is provided
      assert:
        that:
          - target_environment is defined
          - target_environment | length > 0
        fail_msg: "target_environment variable is required. Use: -e target_environment=staging or -e target_environment=prod"
      run_once: true

    - name: Set target namespace
      set_fact:
        target_namespace: "{{ target_environment }}"
      run_once: true

    - name: "Get PostgreSQL service details from {{ target_namespace }} namespace"
      kubernetes.core.k8s_info:
        kind: Service
        name: "database-{{ target_namespace }}-rw"
        namespace: "{{ target_namespace }}"
      register: postgres_service
      retries: 3
      delay: 10
      run_once: true

    - name: "Get Redis service details from {{ target_namespace }} namespace"
      kubernetes.core.k8s_info:
        kind: Service
        name: "cache"
        namespace: "{{ target_namespace }}"
      register: redis_service
      retries: 3
      delay: 10
      run_once: true

    - name: "Get RabbitMQ service details from {{ target_namespace }} namespace"
      kubernetes.core.k8s_info:
        kind: Service
        name: "queue-{{ target_namespace }}"
        namespace: "{{ target_namespace }}"
      register: rabbitmq_service
      retries: 3
      delay: 10
      run_once: true

    - name: "Retrieve PostgreSQL credentials from {{ target_namespace }} namespace"
      kubernetes.core.k8s_info:
        kind: Secret
        name: "database-app"
        namespace: "{{ target_namespace }}"
      register: postgres_secret
      retries: 5
      delay: 10
      until: postgres_secret.resources | length > 0
      run_once: true

    - name: "Retrieve RabbitMQ default credentials from {{ target_namespace }} namespace"
      kubernetes.core.k8s_info:
        kind: Secret
        name: "queue-default-user"
        namespace: "{{ target_namespace }}"
      register: rabbitmq_secret
      retries: 5
      delay: 10
      until: rabbitmq_secret.resources | length > 0
      run_once: true

    - name: Get ArgoCD LoadBalancer IP
      kubernetes.core.k8s_info:
        kind: Service
        name: argocd-server
        namespace: argocd
      register: argocd_svc

    - name: Get Rancher LoadBalancer IP
      kubernetes.core.k8s_info:
        kind: Service
        name: rancher
        namespace: cattle-system
      register: rancher_svc

    - name: Set connection info variables
      set_fact:
        postgres_host: "{{ postgres_service.resources[0].status.loadBalancer.ingress[0].ip if (postgres_service.resources | length > 0 and postgres_service.resources[0].status.loadBalancer.ingress) else '(pending)' }}"
        postgres_user: "{{ postgres_secret.resources[0].data.username | b64decode }}"
        postgres_pass: "{{ postgres_secret.resources[0].data.password | b64decode }}"
        redis_host: "{{ redis_service.resources[0].status.loadBalancer.ingress[0].ip if (redis_service.resources | length > 0 and redis_service.resources[0].status.loadBalancer.ingress) else '(pending)' }}"
        rabbitmq_host: "{{ rabbitmq_service.resources[0].status.loadBalancer.ingress[0].ip if (rabbitmq_service.resources | length > 0 and rabbitmq_service.resources[0].status.loadBalancer.ingress) else '(pending)' }}"
        rabbitmq_user: "{{ rabbitmq_secret.resources[0].data.username | b64decode }}"
        rabbitmq_pass: "{{ rabbitmq_secret.resources[0].data.password | b64decode }}"
        argocd_host: "{{ argocd_svc.resources[0].status.loadBalancer.ingress[0].ip if (argocd_svc.resources | length > 0 and argocd_svc.resources[0].status.loadBalancer.ingress) else '(pending)' }}"
        rancher_host: "{{ rancher_svc.resources[0].status.loadBalancer.ingress[0].ip if (rancher_svc.resources | length > 0 and rancher_svc.resources[0].status.loadBalancer.ingress) else '(pending)' }}"
      run_once: true

    - name: "Write connection information to INI file"
      template:
        src: "{{ playbook_dir }}/../templates/connection-info.ini.j2"
        dest: "{{ playbook_dir }}/../connection-info-{{ target_namespace }}.ini"
        mode: '0600'
      delegate_to: localhost
      run_once: true

    - name: Display success message
      debug:
        msg: "Connection information written to: {{ playbook_dir }}/../connection-info-{{ target_namespace }}.ini"
      run_once: true
