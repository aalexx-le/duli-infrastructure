---
- name: Generate Sealed Secrets for Infrastructure Services
  hosts: localhost
  connection: local
  vars:
    secrets_output_dir: "{{ playbook_dir }}/../../helm/secrets/templates"
  tasks:
    - name: Validate target_environment variable
      assert:
        that:
          - target_environment is defined
          - target_environment in ['staging', 'prod']
        fail_msg: "target_environment must be 'staging' or 'prod'"
        quiet: true

    - name: Set target namespace
      set_fact:
        target_namespace: "{{ target_environment }}"

    - name: Ensure secrets output directory exists
      file:
        path: "{{ secrets_output_dir }}"
        state: directory

    # PostgreSQL superuser (for CloudNativePG operator)
    # Note: Username MUST be "postgres" for CNPG superuserSecret
    # Application user (duli-admin) is auto-created via bootstrap.initdb.owner
    - name: Generate PostgreSQL sealed secret
      block:
        - name: Create temporary secret manifest
          copy:
            content: |
              apiVersion: v1
              kind: Secret
              metadata:
                name: postgres-credentials
                namespace: {{ target_namespace }}
              type: Opaque
              stringData:
                username: "postgres"
                password: "{{ vault_postgres_password }}"
            dest: /tmp/postgres-secret-{{ target_namespace }}.yaml
          no_log: true

        - name: Seal PostgreSQL secret
          shell: |
            kubeseal --format=yaml \
              --controller-name=sealed-secrets-controller \
              --controller-namespace=kube-system \
              < /tmp/postgres-secret-{{ target_namespace }}.yaml \
              > {{ secrets_output_dir }}/postgres-sealed-secret-{{ target_namespace }}.yaml
          changed_when: true
          no_log: true

        - name: Cleanup temporary files
          file:
            path: /tmp/postgres-secret-{{ target_namespace }}.yaml
            state: absent
          no_log: true
      when: vault_postgres_password is defined

    # Redis
    - name: Generate Redis sealed secret
      block:
        - name: Create temporary secret manifest
          copy:
            content: |
              apiVersion: v1
              kind: Secret
              metadata:
                name: redis-credentials
                namespace: {{ target_namespace }}
              type: Opaque
              stringData:
                password: "{{ vault_redis_password }}"
            dest: /tmp/redis-secret-{{ target_namespace }}.yaml
          no_log: true

        - name: Seal Redis secret
          shell: |
            kubeseal --format=yaml \
              --controller-name=sealed-secrets-controller \
              --controller-namespace=kube-system \
              < /tmp/redis-secret-{{ target_namespace }}.yaml \
              > {{ secrets_output_dir }}/redis-sealed-secret-{{ target_namespace }}.yaml
          changed_when: true
          no_log: true

        - name: Cleanup temporary files
          file:
            path: /tmp/redis-secret-{{ target_namespace }}.yaml
            state: absent
          no_log: true
      when: vault_redis_password is defined and vault_redis_password | length > 0

    # NOTE: DigitalOcean API token is managed by CCM playbook in kube-system namespace
    # and synchronized to monitoring namespace via reflector annotations
    # No sealed secret generation needed
    
    # NOTE: RabbitMQ credentials are auto-generated by RabbitMQ Cluster Operator
    # The operator creates 'queue-default-user' secret automatically
    # See: helm/rabbitmq/values.yaml for documentation

    # Keycloak database credentials (shared across environments)
    # Both staging and prod CNPG clusters use the same credentials secret
    - name: Generate Keycloak database sealed secret
      block:
         - name: Create temporary keycloak-db secret manifest
           copy:
             content: |
               apiVersion: v1
               kind: Secret
               metadata:
                 name: keycloak-db-credentials
                 namespace: keycloak-system
               type: Opaque
               stringData:
                 username: "{{ vault_keycloak_db_username }}"
                 password: "{{ vault_keycloak_db_password }}"
             dest: /tmp/keycloak-db-secret.yaml
           no_log: true

         - name: Seal keycloak database secret
           shell: |
             kubeseal --format=yaml \
               --controller-name=sealed-secrets-controller \
               --controller-namespace=kube-system \
               < /tmp/keycloak-db-secret.yaml \
               > {{ secrets_output_dir }}/keycloak-db-credentials-sealed-secret.yaml
           changed_when: true
           no_log: true

         - name: Cleanup temporary files
           file:
             path: /tmp/keycloak-db-secret.yaml
             state: absent
           no_log: true
           when: 
           - vault_keycloak_db_username is defined
           - vault_keycloak_db_password is defined

    # Keycloak OAuth Identity Providers (shared across environments in keycloak-system)
    # Note: This is currently shared, but could be split per environment if needed
    - name: Generate Keycloak OAuth sealed secret
      block:
        - name: Create temporary keycloak-oauth secret manifest
          copy:
            content: |
              apiVersion: v1
              kind: Secret
              metadata:
                name: keycloak-oauth-credentials
                namespace: keycloak-system
              type: Opaque
              stringData:
                google_client_id: "{{ vault_oauth_google_client_id }}"
                google_client_secret: "{{ vault_oauth_google_client_secret }}"
            dest: /tmp/keycloak-oauth-secret.yaml
          no_log: true

        - name: Seal keycloak OAuth secret
          shell: |
            kubeseal --format=yaml \
              --controller-name=sealed-secrets-controller \
              --controller-namespace=kube-system \
              < /tmp/keycloak-oauth-secret.yaml \
              > {{ secrets_output_dir }}/keycloak-oauth-sealed-secret.yaml
          changed_when: true
          no_log: true

        - name: Cleanup temporary files
          file:
            path: /tmp/keycloak-oauth-secret.yaml
            state: absent
          no_log: true
      when:
        - vault_oauth_google_client_id is defined
        - vault_oauth_google_client_secret is defined

    # Grafana Admin Credentials (for monitoring namespace)
    - name: Generate Grafana admin sealed secret
      block:
        - name: Create temporary grafana-admin secret manifest
          copy:
            content: |
              apiVersion: v1
              kind: Secret
              metadata:
                name: grafana-admin-credentials
                namespace: monitoring
              type: Opaque
              stringData:
                admin-user: "admin"
                admin-password: "{{ vault_grafana_admin_password }}"
            dest: /tmp/grafana-admin-secret.yaml
          no_log: true

        - name: Seal Grafana admin secret
          shell: |
            kubeseal --format=yaml \
              --controller-name=sealed-secrets-controller \
              --controller-namespace=kube-system \
              < /tmp/grafana-admin-secret.yaml \
              > {{ secrets_output_dir }}/grafana-admin-credentials-sealed-secret.yaml
          changed_when: true
          no_log: true

        - name: Cleanup temporary files
          file:
            path: /tmp/grafana-admin-secret.yaml
            state: absent
          no_log: true
      when: vault_grafana_admin_password is defined and vault_grafana_admin_password | length > 0

    # Keycloak Backend Service Client Secret (shared across all environments)
    # Note: This is a shared resource in keycloak-system namespace, not environment-specific
    - name: Generate Keycloak backend-service client secret
      block:
        - name: Create temporary keycloak-backend-service secret manifest
          copy:
            content: |
              apiVersion: v1
              kind: Secret
              metadata:
                name: keycloak-backend-service
                namespace: keycloak-system
              type: Opaque
              stringData:
                client_secret: "{{ vault_keycloak_backend_service_secret }}"
            dest: /tmp/keycloak-backend-service-secret.yaml
          no_log: true

        - name: Seal keycloak backend-service secret
          shell: |
            kubeseal --format=yaml \
              --controller-name=sealed-secrets-controller \
              --controller-namespace=kube-system \
              < /tmp/keycloak-backend-service-secret.yaml \
              > {{ secrets_output_dir }}/keycloak-backend-service-sealed-secret.yaml
          changed_when: true
          no_log: true

        - name: Cleanup temporary files
          file:
            path: /tmp/keycloak-backend-service-secret.yaml
            state: absent
          no_log: true
      when: vault_keycloak_backend_service_secret is defined and vault_keycloak_backend_service_secret | length > 0
