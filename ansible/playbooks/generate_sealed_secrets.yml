---
- name: Generate Sealed Secrets for Infrastructure Services
  hosts: localhost
  connection: local
  vars:
    secrets_output_dir: "{{ playbook_dir }}/../../helm/secrets/templates"
  tasks:
    - name: Validate target_environment variable
      assert:
        that:
          - target_environment is defined
          - target_environment in ['staging', 'prod']
        fail_msg: "target_environment must be 'staging' or 'prod'"
        quiet: true

    - name: Set target namespace
      set_fact:
        target_namespace: "{{ target_environment }}"

    - name: Ensure secrets output directory exists
      file:
        path: "{{ secrets_output_dir }}"
        state: directory

    # Redis
    - name: Generate Redis sealed secret
      block:
        - name: Create temporary secret manifest
          copy:
            content: |
              apiVersion: v1
              kind: Secret
              metadata:
                name: redis-credentials
                namespace: {{ target_namespace }}
              type: Opaque
              stringData:
                password: "{{ vault_redis_password }}"
            dest: /tmp/redis-secret-{{ target_namespace }}.yaml
          no_log: true

        - name: Seal Redis secret
          shell: |
            kubeseal --format=yaml \
              --controller-name=sealed-secrets-controller \
              --controller-namespace=kube-system \
              < /tmp/redis-secret-{{ target_namespace }}.yaml \
              > {{ secrets_output_dir }}/redis-sealed-secret-{{ target_namespace }}.yaml
          changed_when: true
          no_log: true

        - name: Cleanup temporary files
          file:
            path: /tmp/redis-secret-{{ target_namespace }}.yaml
            state: absent
          no_log: true
      when: vault_redis_password is defined and vault_redis_password | length > 0

    # PostgreSQL
    - name: Generate PostgreSQL sealed secret
      block:
        - name: Create temporary secret manifest
          copy:
            content: |
              apiVersion: v1
              kind: Secret
              metadata:
                name: postgres-credentials
                namespace: {{ target_namespace }}
              type: Opaque
              stringData:
                password: "{{ vault_postgres_password }}"
            dest: /tmp/postgres-secret-{{ target_namespace }}.yaml
          no_log: true

        - name: Seal PostgreSQL secret
          shell: |
            kubeseal --format=yaml \
              --controller-name=sealed-secrets-controller \
              --controller-namespace=kube-system \
              < /tmp/postgres-secret-{{ target_namespace }}.yaml \
              > {{ secrets_output_dir }}/postgres-sealed-secret-{{ target_namespace }}.yaml
          changed_when: true
          no_log: true

        - name: Cleanup temporary files
          file:
            path: /tmp/postgres-secret-{{ target_namespace }}.yaml
            state: absent
          no_log: true
      when: vault_postgres_password is defined and vault_postgres_password | length > 0

    # RabbitMQ
    - name: Generate RabbitMQ sealed secret
      block:
        - name: Create temporary secret manifest
          copy:
            content: |
              apiVersion: v1
              kind: Secret
              metadata:
                name: rabbitmq-credentials
                namespace: {{ target_namespace }}
              type: Opaque
              stringData:
                password: "{{ vault_rabbitmq_password }}"
            dest: /tmp/rabbitmq-secret-{{ target_namespace }}.yaml
          no_log: true

        - name: Seal RabbitMQ secret
          shell: |
            kubeseal --format=yaml \
              --controller-name=sealed-secrets-controller \
              --controller-namespace=kube-system \
              < /tmp/rabbitmq-secret-{{ target_namespace }}.yaml \
              > {{ secrets_output_dir }}/rabbitmq-sealed-secret-{{ target_namespace }}.yaml
          changed_when: true
          no_log: true

        - name: Cleanup temporary files
          file:
            path: /tmp/rabbitmq-secret-{{ target_namespace }}.yaml
            state: absent
          no_log: true
      when: vault_rabbitmq_password is defined and vault_rabbitmq_password | length > 0