---
- name: Generate Sealed Secrets
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    secrets_dir: "{{ playbook_dir }}/../../helm/secrets/templates"
    controller_name: sealed-secrets-controller
    controller_namespace: kube-system
    target_namespace: staging # Default, can be overridden with -e target_namespace=prod

  tasks:
    - name: Ensure secrets directory exists
      file:
        path: "{{ secrets_dir }}"
        state: directory

    - name: Check if kubeseal is installed
      command: which kubeseal
      register: kubeseal_check
      failed_when: kubeseal_check.rc != 0
      changed_when: false

    - name: Fetch Sealed Secrets Public Key
      shell: |
        kubeseal \
          --controller-name={{ controller_name }} \
          --controller-namespace={{ controller_namespace }} \
          --fetch-cert
      register: pub_cert
      changed_when: false

    - name: Save Public Key to temp file
      copy:
        content: "{{ pub_cert.stdout }}"
        dest: "/tmp/sealed-secrets-pub.pem"

    - name: Define Secrets to Generate
      set_fact:
        secrets_list:
          - name: redis-credentials
            key: password
            prompt: "Enter Redis Password"
          - name: postgres-credentials
            key: password
            prompt: "Enter Postgres Password"
          - name: rabbitmq-credentials
            key: password
            prompt: "Enter RabbitMQ Password"
          - name: keycloak-db-secret
            key: password
            prompt: "Enter Keycloak DB Password"

    - name: Collect Secret Values
      pause:
        prompt: "{{ item.prompt }} for {{ target_namespace }}"
        echo: no
      register: secret_values
      loop: "{{ secrets_list }}"

    - name: Generate Sealed Secrets
      shell: |
        kubectl create secret generic {{ item.item.name }} \
          --from-literal={{ item.item.key }}='{{ item.user_input }}' \
          --namespace {{ target_namespace }} \
          --dry-run=client -o yaml | \
        kubeseal \
          --cert=/tmp/sealed-secrets-pub.pem \
          --format=yaml > {{ secrets_dir }}/{{ item.item.name }}.yaml
      loop: "{{ secret_values.results }}"
      loop_control:
        label: "{{ item.item.name }}"

    - name: Cleanup
      file:
        path: "/tmp/sealed-secrets-pub.pem"
        state: absent

    - name: Success Message
      debug:
        msg: "Successfully generated {{ secret_values.results | length }} sealed secrets in {{ secrets_dir }}. Please commit them to Git."
