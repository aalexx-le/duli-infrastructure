---
- name: Generate Sealed Secrets for Infrastructure Services
  hosts: localhost
  connection: local
  vars:
    secrets_output_dir: "{{ playbook_dir }}/../../helm/secrets/templates"
  tasks:
    # ============================================================================
    # VALIDATION
    # ============================================================================

    - name: Validate target_environment variable
      assert:
        that:
          - target_environment is defined
          - target_environment in ['staging', 'prod']
        fail_msg: "target_environment must be 'staging' or 'prod'. Use: -e target_environment=staging"
      run_once: true

    - name: Set target namespace
      set_fact:
        target_namespace: "{{ target_environment }}"
      run_once: true

    - name: Ensure secrets output directory exists
      file:
        path: "{{ secrets_output_dir }}"
        state: directory
      run_once: true

    # ============================================================================
    # REDIS SEALED SECRET
    # ============================================================================

    - name: Generate Redis Sealed Secret
      block:
        - name: Create temporary Redis secret manifest
          copy:
            content: |
              apiVersion: v1
              kind: Secret
              metadata:
                name: redis-credentials
                namespace: {{ target_namespace }}
              type: Opaque
              stringData:
                password: "{{ vault_redis_password }}"
            dest: /tmp/redis-secret-{{ target_namespace }}.yaml
          no_log: true

        - name: Generate Redis sealed secret using kubeseal
          shell: |
            kubeseal --format=yaml \
              --controller-name=sealed-secrets-controller \
              --controller-namespace=kube-system \
              < /tmp/redis-secret-{{ target_namespace }}.yaml \
              > {{ secrets_output_dir }}/redis-sealed-secret-{{ target_namespace }}.yaml
          changed_when: true
          no_log: true

        - name: Clean up temporary Redis secret
          file:
            path: /tmp/redis-secret-{{ target_namespace }}.yaml
            state: absent
          no_log: true

        - name: Redis secret generated
          debug:
            msg: "‚úÖ Redis sealed secret ‚Üí helm/secrets/templates/redis-sealed-secret-{{ target_namespace }}.yaml"
      when: vault_redis_password is defined and vault_redis_password | length > 0

    # ============================================================================
    # POSTGRESQL SEALED SECRET
    # ============================================================================

    - name: Generate PostgreSQL Sealed Secret
      block:
        - name: Create temporary PostgreSQL secret manifest
          copy:
            content: |
              apiVersion: v1
              kind: Secret
              metadata:
                name: postgres-credentials
                namespace: {{ target_namespace }}
              type: Opaque
              stringData:
                password: "{{ vault_postgres_password }}"
            dest: /tmp/postgres-secret-{{ target_namespace }}.yaml
          no_log: true

        - name: Generate PostgreSQL sealed secret using kubeseal
          shell: |
            kubeseal --format=yaml \
              --controller-name=sealed-secrets-controller \
              --controller-namespace=kube-system \
              < /tmp/postgres-secret-{{ target_namespace }}.yaml \
              > {{ secrets_output_dir }}/postgres-sealed-secret-{{ target_namespace }}.yaml
          changed_when: true
          no_log: true

        - name: Clean up temporary PostgreSQL secret
          file:
            path: /tmp/postgres-secret-{{ target_namespace }}.yaml
            state: absent
          no_log: true

        - name: PostgreSQL secret generated
          debug:
            msg: "‚úÖ PostgreSQL sealed secret ‚Üí helm/secrets/templates/postgres-sealed-secret-{{ target_namespace }}.yaml"
      when: vault_postgres_password is defined and vault_postgres_password | length > 0

    # ============================================================================
    # RABBITMQ SEALED SECRET
    # ============================================================================

    - name: Generate RabbitMQ Sealed Secret
      block:
        - name: Create temporary RabbitMQ secret manifest
          copy:
            content: |
              apiVersion: v1
              kind: Secret
              metadata:
                name: rabbitmq-credentials
                namespace: {{ target_namespace }}
              type: Opaque
              stringData:
                password: "{{ vault_rabbitmq_password }}"
            dest: /tmp/rabbitmq-secret-{{ target_namespace }}.yaml
          no_log: true

        - name: Generate RabbitMQ sealed secret using kubeseal
          shell: |
            kubeseal --format=yaml \
              --controller-name=sealed-secrets-controller \
              --controller-namespace=kube-system \
              < /tmp/rabbitmq-secret-{{ target_namespace }}.yaml \
              > {{ secrets_output_dir }}/rabbitmq-sealed-secret-{{ target_namespace }}.yaml
          changed_when: true
          no_log: true

        - name: Clean up temporary RabbitMQ secret
          file:
            path: /tmp/rabbitmq-secret-{{ target_namespace }}.yaml
            state: absent
          no_log: true

        - name: RabbitMQ secret generated
          debug:
            msg: "‚úÖ RabbitMQ sealed secret ‚Üí helm/secrets/templates/rabbitmq-sealed-secret-{{ target_namespace }}.yaml"
      when: vault_rabbitmq_password is defined and vault_rabbitmq_password | length > 0

    # ============================================================================
    # SUMMARY
    # ============================================================================

    - name: Display next steps
      debug:
        msg: |
          
          üéâ Sealed Secrets Generated Successfully!
          
          üìÅ Location: helm/secrets/templates/
          
          üìã Next Steps (GitOps Workflow):
          
          1. Review generated files:
             ls -lh helm/secrets/templates/*-{{ target_namespace }}.yaml
          
          2. Commit to Git:
             git add helm/secrets/templates/
             git commit -m "Add sealed secrets for {{ target_namespace }}"
             git push origin main
          
          3. ArgoCD will automatically:
             - Detect the changes
             - Sync infrastructure-secrets-{{ target_namespace }}
             - Create secrets in {{ target_namespace }} namespace
          
          4. Verify secrets created:
             kubectl get sealedsecrets -n {{ target_namespace }}
             kubectl get secrets -n {{ target_namespace }}
          
          ‚ö†Ô∏è  Remember: These encrypted secrets are SAFE to commit to Git!
