---
- name: Generate Sealed Secrets for Infrastructure Services
  hosts: localhost
  connection: local
  tasks:
    - name: Validate target_environment variable is provided
      assert:
        that:
          - target_environment is defined
          - target_environment | length > 0
        fail_msg: "target_environment variable is required. Use: -e target_environment=staging or -e target_environment=prod"
      run_once: true

    - name: Set target namespace
      set_fact:
        target_namespace: "{{ target_environment }}"
      run_once: true

    - name: Ensure target namespace exists
      kubernetes.core.k8s:
        name: "{{ target_namespace }}"
        api_version: v1
        kind: Namespace
        state: present
      run_once: true

    # ============================================================================
    # REDIS SEALED SECRET
    # ============================================================================

    - name: Generate Redis Sealed Secret
      block:
        - name: Create temporary secret manifest
          copy:
            content: |
              apiVersion: v1
              kind: Secret
              metadata:
                name: redis-credentials
                namespace: {{ target_namespace }}
              type: Opaque
              stringData:
                password: "{{ vault_redis_password }}"
            dest: /tmp/redis-secret.yaml
          no_log: true

        - name: Generate sealed secret using kubeseal
          shell: |
            kubeseal --format=yaml \
              --controller-name=sealed-secrets-controller \
              --controller-namespace=kube-system \
              < /tmp/redis-secret.yaml > /tmp/redis-sealed-secret.yaml
          register: kubeseal_result
          changed_when: true

        - name: Apply sealed secret
          kubernetes.core.k8s:
            state: present
            src: /tmp/redis-sealed-secret.yaml

        - name: Clean up temporary files
          file:
            path: "{{ item }}"
            state: absent
          loop:
            - /tmp/redis-secret.yaml
            - /tmp/redis-sealed-secret.yaml
          no_log: true

        - name: Display success message
          debug:
            msg: "âœ… Redis Sealed Secret created successfully in {{ target_namespace }} namespace"
      when: vault_redis_password is defined
      run_once: true

    # ============================================================================
    # POSTGRESQL SEALED SECRET (Future)
    # ============================================================================

    # - name: Generate PostgreSQL Sealed Secret
    #   block:
    #     - name: Create temporary secret manifest
    #       copy:
    #         content: |
    #           apiVersion: v1
    #           kind: Secret
    #           metadata:
    #             name: postgres-credentials
    #             namespace: {{ target_namespace }}
    #           type: Opaque
    #           stringData:
    #             password: "{{ vault_postgres_password }}"
    #         dest: /tmp/postgres-secret.yaml
    #       no_log: true
    #
    #     - name: Generate sealed secret using kubeseal
    #       shell: |
    #         kubeseal --format=yaml \
    #           --controller-name=sealed-secrets-controller \
    #           --controller-namespace=sealed-secrets \
    #           < /tmp/postgres-secret.yaml > /tmp/postgres-sealed-secret.yaml
    #       register: kubeseal_postgres_result
    #       changed_when: true
    #
    #     - name: Apply sealed secret
    #       kubernetes.core.k8s:
    #         state: present
    #         src: /tmp/postgres-sealed-secret.yaml
    #
    #     - name: Clean up temporary files
    #       file:
    #         path: "{{ item }}"
    #         state: absent
    #       loop:
    #         - /tmp/postgres-secret.yaml
    #         - /tmp/postgres-sealed-secret.yaml
    #       no_log: true
    #   when: vault_postgres_password is defined
    #   run_once: true

    # ============================================================================
    # RABBITMQ SEALED SECRET (Future)
    # ============================================================================

    # - name: Generate RabbitMQ Sealed Secret
    #   block:
    #     - name: Create temporary secret manifest
    #       copy:
    #         content: |
    #           apiVersion: v1
    #           kind: Secret
    #           metadata:
    #             name: rabbitmq-credentials
    #             namespace: {{ target_namespace }}
    #           type: Opaque
    #           stringData:
    #             password: "{{ vault_rabbitmq_password }}"
    #         dest: /tmp/rabbitmq-secret.yaml
    #       no_log: true
    #
    #     - name: Generate sealed secret using kubeseal
    #       shell: |
    #         kubeseal --format=yaml \
    #           --controller-name=sealed-secrets-controller \
    #           --controller-namespace=sealed-secrets \
    #           < /tmp/rabbitmq-secret.yaml > /tmp/rabbitmq-sealed-secret.yaml
    #       register: kubeseal_rabbitmq_result
    #       changed_when: true
    #
    #     - name: Apply sealed secret
    #       kubernetes.core.k8s:
    #         state: present
    #         src: /tmp/rabbitmq-sealed-secret.yaml
    #
    #     - name: Clean up temporary files
    #       file:
    #         path: "{{ item }}"
    #         state: absent
    #       loop:
    #         - /tmp/rabbitmq-secret.yaml
    #         - /tmp/rabbitmq-sealed-secret.yaml
    #       no_log: true
    #   when: vault_rabbitmq_password is defined
    #   run_once: true
