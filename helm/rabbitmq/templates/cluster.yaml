{{- if .Values.cluster.enabled }}
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: {{ .Values.cluster.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: rabbitmq
    app.kubernetes.io/instance: {{ .Release.Name }}
spec:
  # Cluster topology
  replicas: {{ .Values.cluster.replicas }}

  # Image configuration
  image: {{ .Values.cluster.image }}
  imagePullPolicy: {{ .Values.cluster.imagePullPolicy }}

  # Service configuration
  service:
    type: {{ .Values.cluster.service.type }}

  # Storage configuration
  persistence:
    storageClassName: {{ .Values.cluster.storage.storageClass }}
    size: {{ .Values.cluster.storage.size }}

  # Resource configuration
  resources:
    requests:
      cpu: {{ .Values.cluster.resources.requests.cpu }}
      memory: {{ .Values.cluster.resources.requests.memory }}
    limits:
      cpu: {{ .Values.cluster.resources.limits.cpu }}
      memory: {{ .Values.cluster.resources.limits.memory }}

  # RabbitMQ configuration
  rabbitmq:
    additionalConfig: {{ .Values.cluster.rabbitmq.additionalConfig | quote }}

  # Pod affinity for distribution across nodes
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - rabbitmq
            topologyKey: kubernetes.io/hostname
{{- end }}
