# Alertmanager
alertmanager:
  enabled: true
  config:
    global:
      resolve_timeout: 5m
    route:
      receiver: 'default'
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 12h
      routes:
        - receiver: 'discord-cost-alerts'
          group_by: ['alertname', 'severity']
          matchers:
            - category="cost"
          group_wait: 10s
          group_interval: 24h
          repeat_interval: 24h
          continue: true
        - receiver: 'discord-cost-alerts'
          group_by: ['alertname', 'severity']
          matchers:
            - severity="critical"
          group_wait: 30s
          repeat_interval: 1h
          continue: true
    receivers:
      - name: 'default'
        # Default receiver (can be null or configure email, etc.)
      - name: 'discord-cost-alerts'
        webhook_configs:
          - url: 'http://alertmanager-discord.monitoring.svc.cluster.local:9094'
            send_resolved: true
  alertmanagerSpec:
    replicas: 1
    retention: 120h  # 5 days
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: do-block-storage
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 2Gi
    resources:
      limits:
        cpu: 50m
        memory: 96Mi
      requests:
        cpu: 10m
        memory: 48Mi

# Grafana - Full featured
grafana:
  enabled: true
  adminUser: admin
  admin:
    existingSecret: grafana-admin-credentials
    userKey: admin-user
    passwordKey: admin-password
  
  replicas: 1
  
  persistence:
    enabled: true
    type: pvc
    storageClassName: do-block-storage
    accessModes:
      - ReadWriteOnce
    size: 1Gi
  
  ingress:
    enabled: true
    ingressClassName: nginx
    hosts:
      - grafana.duli.one
    tls:
      - secretName: duli-one-wildcard-tls
        hosts:
          - grafana.duli.one
  
  # Data sources
  additionalDataSources:
    - name: Loki
      type: loki
      url: http://loki-gateway.monitoring.svc.cluster.local
      access: proxy
      isDefault: false
      jsonData:
        maxLines: 1000
        timeout: 60
        httpHeaderName1: "X-Scope-OrgID"
      secureJsonData:
        httpHeaderValue1: "tenant1"
    
    - name: Prometheus
      type: prometheus
      url: http://kube-prometheus-stack-prometheus.monitoring.svc.cluster.local:9090
      access: proxy
      isDefault: true
      jsonData:
        timeInterval: 30s
  
  resources:
    limits:
      cpu: 100m
      memory: 200Mi
    requests:
      cpu: 25m
      memory: 100Mi

  sidecar:
    dashboards:
      enabled: true
      searchNamespace: ALL
      folderAnnotation: grafana_folder
      provider:
        foldersFromFilesStructure: true
      resources:
        limits:
          cpu: 30m
          memory: 48Mi
        requests:
          cpu: 5m
          memory: 24Mi
    datasources:
      enabled: true
      defaultDatasourceEnabled: false  # Disable built-in Prometheus datasource (we define custom ones)
      resources:
        limits:
          cpu: 30m
          memory: 48Mi
        requests:
          cpu: 5m
          memory: 24Mi

# Prometheus - ENABLED with optimized settings
prometheus:
  enabled: true
  prometheusSpec:
    replicas: 1
    retention: 7d  # 7 days retention
    retentionSize: "6300MB"  # Leave ~700MB buffer for 7Gi storage
    
    # Auto-discover ServiceMonitors in all namespaces
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
    ruleSelectorNilUsesHelmValues: false
    probeSelectorNilUsesHelmValues: false
    
    serviceMonitorNamespaceSelector: {}
    podMonitorNamespaceSelector: {}
    ruleNamespaceSelector: {}
    probeNamespaceSelector: {}
    
    # Scrape intervals
    scrapeInterval: 30s
    scrapeTimeout: 10s
    evaluationInterval: 30s
    
    # Send alerts to AlertManager
    alertingEndpoints:
      - name: kube-prometheus-stack-alertmanager
        namespace: monitoring
        port: http-web
        pathPrefix: "/"
    
    # Storage
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: do-block-storage
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 2Gi
    
    # Resources - Optimized for small 3-node cluster
    resources:
      requests:
        cpu: 100m
        memory: 512Mi

      limits:
        cpu: 200m
        memory: 512Mi
    
    # Enable remote write to Loki (for logs)
    additionalScrapeConfigs: []

# Prometheus Operator
prometheusOperator:
  enabled: true
  resources:
    limits:
      cpu: 100m
      memory: 200Mi
    requests:
      cpu: 25m
      memory: 100Mi
  
  # Disable admission webhooks for simplicity
  admissionWebhooks:
    enabled: false
  
  tls:
    enabled: false

# Node exporter - runs on every node
prometheus-node-exporter:
  resources:
    limits:
      cpu: 50m
      memory: 48Mi
    requests:
      cpu: 30m
      memory: 24Mi

# Kube state metrics
kube-state-metrics:
  resources:
    limits:
      cpu: 50m
      memory: 96Mi
    requests:
      cpu: 10m
      memory: 48Mi


# Disable thanos
thanosRuler:
  enabled: false
