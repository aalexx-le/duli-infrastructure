# Bitnami PostgreSQL HA Configuration
# This replaces the single-instance postgres chart with a high-availability cluster

# PostgreSQL configuration
postgresql:
  username: "{{ service_config.user }}"
  password: "{{ service_config.password }}"
  database: "{{ service_config.database }}"
  replicaCount: {{ service_config.replicas.postgresql }}  # 1 primary + N-1 replicas for HA
  replication:
    username: replicator
    password: "{{ service_config.password }}"
  postgresqlMaxConnections: 200
  postgresqlSharedBuffers: 256MB
  postgresqlEffectiveCacheSize: 1GB
  postgresqlMaintenanceWorkMem: 64MB
  postgresqlCheckpointCompletionTarget: 0.9

# Pgpool configuration (connection pooler)
pgpool:
  replicaCount: {{ service_config.replicas.pgpool }}
  adminPassword: "{{ service_config.password }}"
  maxConnections: 200
  numInitChildren: 32

# Persistence configuration
persistence:
  enabled: {{ service_config.persistence.enabled }}
  storageClass: "{{ service_config.persistence.storageClass }}"
  size: {{ service_config.persistence.size }}
  accessModes:
    - ReadWriteOnce

# Resource limits
resources:
  postgresql:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 2Gi
  pgpool:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 512Mi

# Service configuration
service:
  type: ClusterIP
  ports:
    postgresql: 5432
    postgresqlReplication: 5433

# Metrics (optional, for monitoring)
metrics:
  enabled: false

# Backup configuration (optional)
backup:
  enabled: false

