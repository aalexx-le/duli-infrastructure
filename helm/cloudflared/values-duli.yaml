# Cloudflared Tunnel Values for Duli Infrastructure
# Official Chart: cloudflare/cloudflare-tunnel
# Docs: https://github.com/cloudflare/helm-charts/tree/main/charts/cloudflare-tunnel

# Cloudflare tunnel configuration
cloudflare:
  # Cloudflare account ID (get from Cloudflare dashboard)
  # Find at: https://dash.cloudflare.com/ -> select account -> Account ID
  account: ""  # Set via Ansible from vault
  
  # Tunnel name (created via `cloudflared tunnel create`)
  tunnelName: "duli-tunnel"
  
  # Tunnel ID (UUID from `cloudflared tunnel list`)
  tunnelId: ""  # Set via Ansible from vault
  
  # Tunnel secret (credentials from tunnel creation)
  secret: ""  # Set via Ansible from vault
  
  # Use existing secret instead of creating new one
  secretName: cloudflared-credentials
  
  # Enable WARP routing for TCP (required for TCP services)
  enableWarp: true

  # Force IPv4 for edge connections to avoid IPv6 WARP policy issues
  edgeIPVersion: "4"

  # Ingress rules - route traffic to internal Kubernetes services
  ingress:
    # Staging PostgreSQL
    - hostname: db.staging.duli.one
      service: tcp://database-rw.staging.svc.cluster.local:5432
    
    # Staging Redis
    - hostname: redis.staging.duli.one
      service: tcp://redis-replication.staging.svc.cluster.local:6379
    
    # Staging RabbitMQ AMQP
    - hostname: mq.staging.duli.one
      service: tcp://queue.staging.svc.cluster.local:5672
    
    # Production PostgreSQL
    - hostname: db.duli.one
      service: tcp://database-rw.prod.svc.cluster.local:5432
    
    # Production Redis
    - hostname: redis.duli.one
      service: tcp://redis-replication.prod.svc.cluster.local:6379
    
    # Production RabbitMQ AMQP
    - hostname: mq.duli.one
      service: tcp://queue.prod.svc.cluster.local:5672

    # Staging HTTPS Services via Ingress-Nginx
    - hostname: argocd-staging.duli.one
      service: http://ingress-nginx-controller.ingress-nginx.svc.cluster.local:80

    - hostname: rancher-staging.duli.one
      service: http://ingress-nginx-controller.ingress-nginx.svc.cluster.local:80

    - hostname: queue-staging.duli.one
      service: http://ingress-nginx-controller.ingress-nginx.svc.cluster.local:80

    # Production HTTPS Services via Ingress-Nginx
    - hostname: argocd.duli.one
      service: http://ingress-nginx-controller.ingress-nginx.svc.cluster.local:80

    - hostname: rancher.duli.one
      service: http://ingress-nginx-controller.ingress-nginx.svc.cluster.local:80

    - hostname: queue.duli.one
      service: http://ingress-nginx-controller.ingress-nginx.svc.cluster.local:80

    # Note: Catch-all rule (http_status:404) is automatically added by the Helm template

# Image configuration
image:
  repository: cloudflare/cloudflared
  pullPolicy: IfNotPresent
  tag: "2024.12.2"  # Specific version for reproducibility

# Number of replicas for high availability
replicaCount: 2

# Service account
serviceAccount:
  annotations: {}
  name: ""  # Auto-generated

# Pod annotations (for Prometheus monitoring)
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "2000"
  prometheus.io/path: "/metrics"

podLabels: {}

# Pod security context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 65532
  sysctls:
    # Allow ICMP traffic (ping, traceroute) to services
    - name: net.ipv4.ping_group_range
      value: "65532 65532"

# Container security context
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true

# Resources
resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 256Mi

# Liveness probe
livenessProbe:
  httpGet:
    path: /ready
    port: 2000
  initialDelaySeconds: 10
  periodSeconds: 10
  failureThreshold: 3

# Readiness probe
readinessProbe:
  httpGet:
    path: /ready
    port: 2000
  initialDelaySeconds: 5
  periodSeconds: 5
  successThreshold: 1
  failureThreshold: 3

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity - spread pods across nodes for HA
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - cloudflare-tunnel
          topologyKey: kubernetes.io/hostname
