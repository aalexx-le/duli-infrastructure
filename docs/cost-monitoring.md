# Cost Monitoring Stack

Daily DigitalOcean cost reports sent to Discord via CronJob.

## Architecture

**Flow:** DO Cost Exporter → Prometheus → CronJob → Discord

**Components:**
- **DO Cost Exporter**: DigitalOcean infrastructure costs (droplets, volumes, load balancers)
- **Prometheus**: Metrics collection
- **CronJob**: Daily report generation and Discord delivery
- **Grafana**: Dashboards & visualization

## Quick Start

### Prerequisites
- Add `vault_discord_webhook_url` to `vault.yml`
- Verify `vault_do_api_token` exists in `vault.yml`

### Generate Sealed Secret
```bash
cd ansible
ansible-playbook playbooks/generate_sealed_secrets.yml -e target_environment=staging
```

### Deploy
```bash
ansible-playbook -i inventories/hosts.ini playbooks/install_infrastructures.yml -e target_environment=staging
```

ArgoCD auto-deploys:
- do-cost-exporter (metrics exporter + daily report cronjob)

## Configuration Details

### DO Cost Exporter Helm Chart

**Components:**
- Deployment: Exports DigitalOcean costs to Prometheus metrics
- CronJob: Sends daily cost report to Discord at 9 AM UTC
- ConfigMap: Report script and Jinja2 template

**Files:**
- `helm/do-cost-exporter/Chart.yaml` - Metadata
- `helm/do-cost-exporter/values.yaml` - Configuration
- `helm/do-cost-exporter/files/report.py` - Report generation script
- `helm/do-cost-exporter/files/report_template.md` - Jinja2 template for Discord message

### Report Template

The report groups volumes by service (postgresql, redis, rabbitmq, etc.) using Prometheus `kube_persistentvolumeclaim_info` metrics.

**Template variables:**
- `date` - Current date
- `total_daily` - Total daily cost
- `total_monthly` - Estimated monthly cost (daily * 30)
- `droplets` - List of droplets with name, cost, specs
- `volumes` - List of volumes grouped by service with name, cost, size_gb, count
- `loadbalancers` - List of load balancers with name, cost

### Discord Secret

The webhook URL is stored as a SealedSecret:
- Secret name: `discord-webhook-secret`
- Key: `webhook_url`
- Namespace: `monitoring`

Generated by Ansible playbook from `vault_discord_webhook_url`.

## Verification

### Check Components Deployed
```bash
kubectl get pods -n monitoring -l app=do-cost-exporter
kubectl get cronjob -n monitoring
```

### Test Report Manually
```bash
kubectl create job --from=cronjob/cost-report cost-report-test -n monitoring
kubectl logs job/cost-report-test -n monitoring
```

### Check Prometheus Metrics
```bash
kubectl port-forward -n monitoring svc/kube-prometheus-stack-prometheus 9090:9090
# Query: do_cost_exporter_resource_cost
```

## Troubleshooting

### No metrics in Prometheus
```bash
kubectl logs -n monitoring -l app=do-cost-exporter
```

### Report not sending to Discord
```bash
# Check cronjob logs
kubectl logs -n monitoring job/cost-report-test

# Verify secret exists
kubectl get secret discord-webhook-secret -n monitoring
```

### Volumes not grouped correctly
The report uses `kube_persistentvolumeclaim_info` from kube-state-metrics to map PV names to services. Check:
```bash
kubectl port-forward -n monitoring svc/kube-prometheus-stack-prometheus 9090:9090
# Query: kube_persistentvolumeclaim_info
```

## Cost Estimates

**DigitalOcean Infrastructure:**
- Droplet (2GB): ~$0.40/day
- Droplet (4GB): ~$0.80/day
- Load Balancer: ~$0.40/day
- Volume (10GB): ~$0.033/day

## Files Reference

| File | Purpose |
|------|---------|
| `helm/do-cost-exporter/files/report.py` | Report generation script |
| `helm/do-cost-exporter/files/report_template.md` | Discord message template |
| `helm/do-cost-exporter/templates/cronjob.yaml` | Daily report CronJob |
| `helm/do-cost-exporter/values.yaml` | Chart configuration |
| `ansible/playbooks/generate_sealed_secrets.yml` | Generates discord-webhook-secret |
| `ansible/inventories/group_vars/all/vault.yml` | `vault_discord_webhook_url` |
