---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: scheduler-{{ target_env }}
  namespace: argocd
  labels:
    app.kubernetes.io/name: scheduler
    app.kubernetes.io/component: application
    app.kubernetes.io/managed-by: argocd
    environment: "{{ target_env }}"
  annotations:
    # ========================================================================
    # ArgoCD Image Updater Configuration
    # ========================================================================
    # Automatically updates image tags when new versions are pushed to registry
    
    # Image list to watch (format: alias=image_path)
    argocd-image-updater.argoproj.io/image-list: scheduler=registry.gitlab.com/duli.ai-engineering/scheduler
    
    # Update strategy: semver, latest-tag, digest, name
    # semver: follows semantic versioning (recommended)
    argocd-image-updater.argoproj.io/scheduler.update-strategy: semver
    
    # Tag filter: only update to tags matching this regex
    # Staging: accept any semver tag (0.0.x, 0.1.x, etc.)
    # Production: only stable releases (no -rc, -beta, -alpha)
{% if target_env == 'staging' %}
    argocd-image-updater.argoproj.io/scheduler.allow-tags: regexp:^[0-9]+\.[0-9]+\.[0-9]+$
{% else %}
    argocd-image-updater.argoproj.io/scheduler.allow-tags: regexp:^[0-9]+\.[0-9]+\.[0-9]+$
    argocd-image-updater.argoproj.io/scheduler.ignore-tags: regexp:.*-(rc|beta|alpha).*
{% endif %}
    
    # Helm-specific: which value to update
    argocd-image-updater.argoproj.io/scheduler.helm.image-name: image.repository
    argocd-image-updater.argoproj.io/scheduler.helm.image-tag: image.tag
    
    # Git write-back configuration
    # Staging: direct commit to main branch (fast deployment)
    # Production: create Pull Request for review (safe deployment)
{% if target_env == 'staging' %}
    argocd-image-updater.argoproj.io/write-back-method: git:secret:argocd/git-creds
    argocd-image-updater.argoproj.io/git-branch: main
{% else %}
    argocd-image-updater.argoproj.io/write-back-method: git:secret:argocd/git-creds:pr
    argocd-image-updater.argoproj.io/git-branch: main
{% endif %}
    
    # Pull secret for private GitLab registry
    argocd-image-updater.argoproj.io/scheduler.pull-secret: secret:argocd/gitlab-registry-creds
    
    # Update interval (default: 2m)
    argocd-image-updater.argoproj.io/scheduler.update-interval: 2m
spec:
  project: default

  source:
    repoURL: https://github.com/aalexx-le/duli-infrastructure
    targetRevision: main
    path: helm/scheduler
    helm:
      releaseName: scheduler
      valueFiles:
        - ../values/scheduler-values-{{ target_env }}.yaml

  destination:
    server: https://kubernetes.default.svc
    namespace: "{{ target_env }}"

  syncPolicy:
    syncOptions:
      - CreateNamespace=false
    automated:
      prune: true
      selfHeal: true
      allowEmpty: false

  # Ignore unknown Helm schema errors
  ignoreDifferences:
    - group: apiextensions.k8s.io
      kind: CustomResourceDefinition
      jsonPointers:
        - /spec/conversion/webhook/clientConfig/caBundle
